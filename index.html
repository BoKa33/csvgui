<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8"/>

	<title>Crosscheck Result Images</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js" integrity="sha512-CSBhVREyzHAjAFfBlIBakjoRUKp5h7VSweP0InR/pAJyptH7peuhCsqAI/snV+TwZmXZqoUklpXp6R6wMnYf5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script>


	var CSV = [];
	var buttons = [];
	var images = [];
	var config;

	applyConfig()

	async function applyConfig(){
		config = await getConfig();
		await images.push(document.getElementById("image_field0"));
		var images_container = await document.getElementById("images_container");
		if(config.csvfile_params.default_image_URL_Columns.length > 1){
			for(var i = 1; i < config.csvfile_params.default_image_URL_Columns.length; i++){
				clone = images[0].cloneNode(true);
				clone.id = ("image_field"+i);
				clone.firstElementChild.id = ("comparision_image"+i);
				images_container.appendChild(clone);
				images.push(clone.firstElementChild);
			}
		}
			await buttons.push(document.getElementById("SelButton0"));
			buttons[0].value = config.options[0].buttonvalue;
			var button_container = await document.getElementById("control_images");
			for (let i = 1; i < config.options.length; i++) {
				clone = buttons[0].cloneNode(true);
				clone.value = config.options[i].buttonvalue;
				clone.id = ("SelButton"+i);
				button_container.appendChild(clone);
				buttons.push(clone);
			}
		document.getElementById("pls_download").innerHTML = config.UI_text.pls_download.replace('{0}', config.csvfile_params.new_column_name);
		document.getElementById("comparision_image0").alt = config.UI_text.img_alt;
		document.getElementById("control_explanation").innerHTML = config.UI_text.task_explanation;
	}
	async function start(){
		try {
			await loadCSV();
			await addFeedbackRow();
			await process_recursive(1);
			document.getElementById("control_images").style.display = "none";
			document.getElementById("ExportArea").style.display = "block";
		} catch (error) {
			alert(error);
		}

	}

	async function getConfig() {
		try {
			const response = await fetch('config.yml');
			const yamlText = await response.text();
			const config = jsyaml.load(yamlText);
			return config;
		} catch (error) {
			console.error('Fehler beim Laden der Konfigurationsdatei:', error);
			throw error;
		}
	}

	function loadCSV() {
		return new Promise((resolve, reject) => {
			const file = document.getElementById("CSV_file_upload").files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(event) {
					const data = event.target.result;
					const lines = data.split("\n");
					let CSVArray = [];

					for (let i = 0; i < lines.length; i++) {
						let fields = lines[i].split(config.csvfile_params.CSV_delimiter_default);
						CSVArray.push(fields.map(value => value.trim()));
					}

					CSV = CSVArray;
					document.getElementById("CSVloading").style.display = "none";
					document.getElementById("ComparisonGUI").style.display = "block";
					resolve();
				};
				reader.onerror = function(error) {
					console.error(error.target.error);
					reject(error);

				};
				reader.readAsText(file);
			} else {
				reject("Please upload a valid CSV file.");
			}
		});
	}
	function addFeedbackRow(){
		console.log(CSV);
		CSV[0].push("sel");
		console.log(CSV);
		for(i = 1; i < CSV.length; i++){
			if(CSV[i].length > 2){
				CSV[i].push("");
			}
			else{
				CSV.splice(i);
			}
		}
	}
	async function process_recursive(iteration){
		try {
			for(var i = 0; i < images.length;i++){
				document.getElementById("comparision_image"+i).src = CSV[iteration][config.csvfile_params.default_image_URL_Columns[i]];
			}
			const feedback = await waitForClick();
			console.log(feedback);
			CSV[iteration][CSV[iteration].length - 1] = feedback;
			console.log(CSV[iteration]);
			if(iteration+1 < CSV.length){
				await process_recursive(iteration+1);
			}
		} catch (error) {
			console.error(error);
			if(iteration+1 < CSV.length){
				await process_recursive(iteration+1);
			}
		}
	}
	function waitForClick() {
		return new Promise((resolve) => {
			const clickListeners = [];
			const keydownListener = (event) => {
				for (let i = 0; i < config.options.length; i++) {
					if (event.key === config.options[i].shortcut_key) {
						resolve(config.options[i].label);
						// Remove the event listeners after a button is pressed
						clickListeners.forEach((listener, index) => {
							document.getElementById("SelButton" + index).removeEventListener("click", listener);
						});
						window.removeEventListener("keydown", keydownListener);
						return;
					}
				}
			};

			// Add click event listeners to buttons
			for (let i = 0; i < config.options.length; i++) {
				const button = document.getElementById("SelButton" + i);
				const clickListener = () => resolve(config.options[i].label);
				button.addEventListener("click", clickListener, { once: true });
				clickListeners.push(clickListener);
			}

			window.addEventListener("keydown", keydownListener);
		});
	}


	function exportCSV(){
		newCSV = "";
		for(i = 0; i < CSV.length; i++){
			newCSV += (CSV[i].join(",") + "\n");
		}
		const blob = new Blob([newCSV], { type: 'text/csv' });
		const blobUrl = window.URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = blobUrl;
		a.download = 'file.csv';
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
		window.URL.revokeObjectURL(blobUrl);
	}
	</script>
	<style>
	body {
		max-height: 100%;
	}
	input {
		margin-bottom: 2.5%;
	}
	.Image {
		height: 100%;
		width: auto;
	}
	.UICentered {
		margin: 0 auto;
		width: 50%;
		margin-left: auto;
		margin-right: auto;
		padding-top: 3%;
	}
	</style>
</head>
<body>
	<div id="CSVloading" class="UICentered">
		<p> Upload the <b> CSV file </b> you want to use: </p>
		<input type="file" class="form-control" id="CSV_file_upload" accept=".csv" def/>

		<p> Press this if done: </p>
		<input type="button" class="btn btn-secondary" id="loadButton" value="Load" onclick="start()">
	</div>
	<div id="ComparisonGUI", style="display: none;" class="UICentered">
		<div id="control_images">
			<table class="table">
				<tr id="images_container">
					<td id="image_field0">
						<img class="Image" id="comparision_image0", src="", alt="Image"></img>
					</td>
				</tr>
			</table>
			<!-- Controls -->
			<p id="control_explanation"></p>
			<input type="button" class="btn btn-secondary" id="SelButton0" value=""/>
		</div>
		<div id="ExportArea" style="display: none;">
			<p id="pls_download"></p>
			<input type="button" class="btn btn-secondary" id="export" onclick="exportCSV()" value="Export/Download Result" alt="Downloads the Result as CSV File">
		</div>
	</div>
</body>
</html>
